<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>gpilab.com</title>

            <link href="http://gpilab.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="gpilab.com Full Atom Feed" />
            <link href="http://gpilab.github.io/feeds/posts.atom.xml" type="application/atom+xml" rel="alternate" title="gpilab.com Categories Atom Feed" />

        <!-- Bootstrap Core CSS -->
        <link href="http://gpilab.github.io/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://gpilab.github.io/theme/css/clean-blog.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://gpilab.github.io/theme/css/code_blocks/darkly.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->






			<meta property="og:locale" content="en">
		<meta property="og:site_name" content="gpilab.com">

	<meta property="og:type" content="article">
	<meta property="article:author" content="">
	<meta property="og:url" content="http://gpilab.github.io/2016/Feb/16/gpi-and-the-bart/">
	<meta property="og:title" content="GPI and the BART">
	<meta property="og:description" content="">
	<meta property="og:image" content="http://gpilab.github.io//images/borg.jpg">
	<meta property="article:published_time" content="2016-02-16 12:56:00-07:00">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://gpilab.github.io/">gpilab.com</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                    <!-- NRZ manually added -->
                    <li><a href="http://docs.gpilab.com">documentation</a></li>


                            <li><a href="http://gpilab.github.io/downloads/">Downloads</a></li>
                            <li><a href="http://gpilab.github.io/community/">Community</a></li>
                            <li><a href="http://gpilab.github.io/screencasts/">Screencasts</a></li>
                            <li><a href="http://gpilab.github.io/about/">About</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/images/borg.jpg')">
        <div class="container intro-header-overlay">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>GPI and the BART</h1>
                        <span class="meta">Posted by
                                <a href="http://gpilab.github.io/author/nicholas-zwart.html">Nicholas Zwart</a>
                             on Tue 16 February 2016
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>Recently, the <a href="https://en.wikipedia.org/wiki/Borg_(Star_Trek)">BORG</a>
has been used to wrap the <a href="http://mrirecon.github.io/bart/"
target="_blank">Berkeley Advanced Reconstruction Toolbox (BART)</a> into a GPI
node library for the purpose of allowing GPI users to easily explore and
utilize this new compressed sensing library.  This <a
href="https://github.com/nckz/bart/blob/master/gpi/README.md"
target="_blank">GPI-BART library</a> is accompanied by some example networks
that demonstrate basic wavelet based compressed sensing as well as some of the
advanced joint compressed sensing and parallel imaging techniques that the BART
package provides for MR reconstruction.  This post gives an introductory
overview of how the BART was wrapped in GPI and how the <a
href="https://github.com/nckz/bart/blob/master/gpi/README.md"
target="_blank">GPI-BART node library</a> can be installed using the latest <a
href="http://dev.gpilab.com" target="_blank">GPI v1</a>.</p>
<h2>The BORG</h2>
<p>One of the new features in <a href="/downloads" target="_blank">GPI
v1</a> is the BORG interface which allows node developers to easily assimilate
command-line tools for native use in GPI.  The BORG, which stands for Building
Outside Relationships with GPI, provides a simple wrapper interface that takes
care of the file I/O required to communicate with external binaries.  In the
case of the BART, most of the tools require an input data file to process and
subsequently produce a data file as an output.  The BORG simply manages the
temporary files required for this I/O.  Reader and writer functions are
required to translate the Python object (in GPI) to the appropriate file format
for the command-line tool.  In this case the BART comes with a Python library
that translates their CFL/HDR file format to Numpy complex float arrays.  This
can be observed in the following code snippet of a GPI node that wraps the
BART's <code>traj</code> command.</p>
<div class="highlight"><pre><span></span><span class="c1"># load commandline tools</span>
<span class="kn">from</span> <span class="nn">bart.gpi.borg</span> <span class="kn">import</span> <span class="n">IFilePath</span><span class="p">,</span> <span class="n">OFilePath</span><span class="p">,</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">bart.python.cfl</span> <span class="kn">import</span> <span class="n">cfl</span> <span class="c1"># BART file format</span>
<span class="o">...</span>
    <span class="c1"># grab user input from UI widgets</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVal</span><span class="p">(</span><span class="s1">&#39;readout samples&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVal</span><span class="p">(</span><span class="s1">&#39;phase encoding lines&#39;</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVal</span><span class="p">(</span><span class="s1">&#39;acceleration&#39;</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVal</span><span class="p">(</span><span class="s1">&#39;radial&#39;</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVal</span><span class="p">(</span><span class="s1">&#39;golden-ratio sampling&#39;</span><span class="p">)</span>

    <span class="c1"># assemble the argument string</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_path</span><span class="o">+</span><span class="s1">&#39;/traj&#39;</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-x &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-y &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-a &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="n">r</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;-r&#39;</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="n">g</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;-G&#39;</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="n">d</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;-D&#39;</span><span class="p">]</span>

    <span class="c1"># setup temp file for getting data back</span>
    <span class="c1"># from the external command</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">OFilePath</span><span class="p">(</span><span class="n">cfl</span><span class="o">.</span><span class="n">readcfl</span><span class="p">,</span> <span class="n">asuffix</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.cfl&#39;</span><span class="p">,</span><span class="s1">&#39;.hdr&#39;</span><span class="p">])</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>

    <span class="c1"># run commandline and echo full command string</span>
    <span class="k">print</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

    <span class="c1"># set GPI node output</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="s1">&#39;trajectory&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">())</span>

    <span class="k">return</span> <span class="mi">0</span>
</pre></div>


<p>The example above starts with a local import of the BORG tools, which were
developed in tandem with this node library.  The GPI widgets values are then
translated to command-line arguments, which are held as strings in a Python
<code>list</code> object.  Since the <code>Traj</code> node generates k-space trajectory coordinates,
it requires an output file path to write out the trajectory data.  The
<code>OFilePath</code> object takes a reference to the file format reader function and
generates a random temporary filename which is included in the arguments list.
When the <code>Command</code> object executes with the argument list, it spawns a <code>traj</code>
process and waits for it to finish and then it uses the reader function to
convert the file to a Numpy array.  The <code>OFilePath</code> object provides a reference
to the Numpy via its <code>data()</code> method.  Finally, when the <code>OFilePath</code> object
falls out of scope it cleans up the temporary file on disk.  The random
filenames are important since the GPI canvas may contain multiple instances of
the <code>Traj</code> node.  The BORG interface simplifies this process which can save
time when wrapping a large library like the BART.</p>
<p>For more examples, check out the wrapper nodes to the
<a href="https://github.com/nckz/bart/tree/master/gpi">BART</a> and
<a href="https://github.com/aganders3/gpi-neurotools/tree/master/FSL/GPI">FSL</a>
libraries.</p>
<h2>Why a Fork?</h2>
<p>The <a href="https://github.com/nckz/bart/blob/master/gpi/README.md"
target="_blank">GPI-BART library</a> is built off of a fork of the actual <a
href="http://mrirecon.github.io/bart/" target="_blank">BART project</a>.  While
the GPI wrappers could be considered a separate project, the BART project is
currently undergoing a lot of development and the fork effectively ensures that
the interface between the GPI wrappers and the BART is compatible.  Another
advantage is that this library can coexist with other BART installations on the
same machine without interfering.</p>
<h2>BART Data Conventions</h2>
<p>The BART and GPI projects have a few key organizational differences in how they
convey numeric arrays and k-space coordinates.  In order to pass the data
between nodes from each library, the data need to be manipulated to fit the
each node's requirements. This is easily accomplished with the core GPI nodes.
Lets start with an example of the worst case scenario: the <code>traj</code> node.</p>
<p><img alt="fitw75" src="http://gpilab.github.io/images/BARTDataConvention.png" /></p>
<p>The image above shows an example gridded 2D radial trajectory (via the BART
node library) and a gridded 2D spiral trajectory (via the GPI core library).
Starting from the top nodes, you can see that the <code>Traj</code> node produces radial
coordinates with dimensions <code>[3, 256, 32]</code> which is 3 cartesian coordinates,
256 sample points and 32 radial arms.  The spiral coordinates from
<code>SpiralCoords</code> are ordered <code>[32, 256, 2]</code> for 32 spiral arms, 256 sample points
and 2 cartesian coordinates.</p>
<h3>Step 1: Reduce Coordinates</h3>
<p>Since this is a 2D trajectory, the <code>Traj</code> node passes zeros for the 'Z'
coordinate and the <code>SpiralCoords</code> node passes 2 coordinates per point.  In
order to use the radial trajectory with the core <code>Grid</code> node, the 3rd
coordinate of the array must be cropped out.  This is accomplished with the
<code>Reduce</code> node set to <code>B/E</code> where the '(B)eginning' index is 1 and the
'(E)nding' index is 2.  You can see that after <code>Reduce</code>, the <code>Traj</code> dimensions
are <code>[2, 256, 32]</code>.</p>
<h3>Step 2: Transpose Dimensions</h3>
<p>The <code>Transpose</code> node is used to flip the order that the trajectory data is
organized in. After the <code>Transpose</code> node, the dimensions are <code>[32, 256, 2]</code>,
which matches the order of the spiral coordinates.</p>
<h3>Step 3: Recast the Data Type</h3>
<p>If you hover the mouse cursor over the coordinate port on the <code>Grid</code> node a
tooltip will pop up with the data type required by that port. In this case,
<code>Grid</code> can take floating point arrays with single or double precision.
Hovering over the <code>Traj</code> output port shows that the array is of type <code>complex
float</code>.  In this case the trajectory definition only makes use of the real
component so the imaginary component is set to zero.  This can be directly
recast into a float array without loss of data.</p>
<h3>Step 4: Coordinate Scaling</h3>
<p>You have noticed that the first node after <code>Traj</code> is <code>Math</code>.  This is because
the trajectory coordinate convention used in the BART is from N/2-1 to N/2
where N is the number of points along a dimension of the grid matrix.  The GPI
core library uses the convention of -0.5 to 0.5.  So the coordinates are
divided by the target matrix size via element-wise scalar division.</p>
<p>This example has shown how the BART and core GPI nodes can be easily adapted to
communicate data between the two libraries using the stock data manipulation
nodes in the core library.  The conventions for data between these two
libraries are different as would be expected between any two libraries that are
developed independently.  The goal for this example is to show that a cross
library data transfer may require some extra attention.</p>
<p><img alt="fitw75" src="http://gpilab.github.io/images/BARTDataConvention_BNI2BART.png" /></p>
<p>Another approach to this problem would be to integrate these differences into
the nodes themselves.  An example of this can be seen in the image above.  The
<code>SpiralCoords</code> node is generating a trajectory that is reformatted using the
<code>BNI2BART_Traj</code> node (included in the wrapper library).  This allows the
coordinates to be directly used in the BART's <code>NuFFT</code> node.</p>
<h2>GPI-BART Installation</h2>
<p>There are two components to the <a
href="https://github.com/nckz/bart/blob/master/gpi/README.md"
target="_blank">GPI-BART node library</a> installation: the BART compilation
and the GPI node library installation.  Before starting download or clone the
GPI-BART fork:</p>
<p>First (if you haven't already), make a 'gpi' directory in your home directory.
If you're not sure why you'd do this, checkout the post <a href="/2015/06/30/Installing-Node-Libraries">Installing Node
Libraries</a>.</p>
<div class="highlight"><pre><span></span>    $ cd ~/
    $ mkdir ~/gpi
    $ cd ~/gpi
</pre></div>


<p>Next, use <a href="https://git-scm.com/">git</a> to clone the node library project into a
directory called 'bart'.</p>
<div class="highlight"><pre><span></span>    $ git clone https://github.com/nckz/bart.git bart
</pre></div>


<h3>BART Compilation</h3>
<p>The BART compilation instructions can be found in the
<a href="https://github.com/nckz/bart#22-downloading-and-compilation">README.md</a> in the
base directory of the project source code.  To summarize, the BART has some
third party library dependencies that are specific to each OS (e.g. <a href="https://github.com/nckz/bart#212-mac-os-x">Mac
OSX</a>).  For OSX, the Xcode and the
gcc compiler must be installed before the <code>make</code> command can be issued.  Once
you've installed the dependencies, make the BART.</p>
<div class="highlight"><pre><span></span>    $ cd ~/gpi/bart
    $ make
</pre></div>


<p>This will make the BART command-line executables, which will be accessible from
the <code>~/gpi/bart</code> directory.</p>
<h3>Installing Node Libraries</h3>
<p>The BART compilation instructions above basically install the BART under a GPI
node library directory structure.  GPI will look at the <code>~/gpi/bart</code> directory
as if it where a Python library.  In our fork, we've included the GPI wrapper
nodes under the <a href="https://github.com/nckz/bart/tree/master/gpi"><code>bart/gpi</code></a>
directory. This fixed directory structure allows the wrapper code to maintain
the relative paths for the BART executables.  Since the GPI wrappers are pure
Python, they don't require compilation. If your GPI installation is setup with
the default paths then GPI-BART library is ready to go.</p>
<p>If you have path modifications in your <code>~/.gpirc</code> file or the nodes are not
visible in your library menu, consult the
<a href="http://docs.gpilab.com/en/develop/config.html">Configuration</a> docs or check out the
post on <a href="/2015/06/30/Installing-Node-Libraries">Installing Node
Libraries</a>.</p>
<h2>Events</h2>
<p>This work has been presented at the <a href="http://www.ismrm.org/workshops/Data16/">ISMRM Workshop on Data Sampling &amp; Image
Reconstruction</a> in Sedona Arizona this
last January and will be presented at the <a href="http://www.ismrm.org/2016-annual-meeting-exhibition/">ISMRM Annual Meeting &amp;
Exhibition</a> in Singapore
this March.</p>
<h2>Thanks</h2>
<p>We'd like to thanks the BART developers at UC Berkeley for their help in
building these nodes.</p>
    </article>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">Blog powered by <a href="http://getpelican.com">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://gpilab.github.io/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://gpilab.github.io/theme/js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="http://gpilab.github.io/theme/js/clean-blog.min.js"></script>

</body>

</html>